{{- if .Values.tests.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "nlp-api.fullname" . }}-test"
  namespace: {{ .Values.global.namespace | default .Release.Namespace }}
  labels:
    {{- include "nlp-api.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: test
      image: "{{ .Values.tests.image.repository }}:{{ .Values.tests.image.tag }}"
      command: ['sh', '-c']
      args:
        - |
          echo "Testing API health endpoint..."
          curl -f http://{{ include "nlp-api.fullname" . }}-service:{{ .Values.service.port }}/health
          echo "Testing API chat endpoint..."
          curl -f -X POST http://{{ include "nlp-api.fullname" . }}-service:{{ .Values.service.port }}/nlp/chat \
            -H "Content-Type: application/json" \
            -d '{"prompt": "Hello test"}'
          echo "All tests passed!"
{{- end }}