{- if .Values.nginx.customConfig.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "nlp-ingress.fullname" . }}-nginx-config
  namespace: {{ .Values.global.namespace | default .Release.Namespace }}
  labels:
    {{- include "nlp-ingress.labels" . | nindent 4 }}
data:
  # Custom config nginx for ML workloads
  proxy-read-timeout: "300"
  proxy-send-timeout: "300"
  proxy-connect-timeout: "60"
  proxy-body-size: "500m"
  proxy-buffer-size: "16k"
  proxy-buffers: "8 16k"
  client-header-buffer-size: "64k"
  large-client-header-buffers: "4 64k"
  
  # Rate limiting
  limit-req-status-code: "429"
  limit-connections: "100"
  
  # Logging
  access-log-params: >-
    buffer=16k flush=5s
  log-format-upstream: >-
    $remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent
    "$http_referer" "$http_user_agent" $request_length $request_time
    [$proxy_upstream_name] [$proxy_alternative_upstream_name] $upstream_addr
    $upstream_response_length $upstream_response_time $upstream_status $req_id
  
  # SSL Configuration
  ssl-protocols: "TLSv1.2 TLSv1.3"
  ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
  ssl-prefer-server-ciphers: "on"
  
  {{- range $key, $value := .Values.nginx.customConfig.data }}
  {{ $key }}: {{ $value | quote }}
  {{- end }}
{{- end }}